var ns={high:"http://schemaapp.com/ontology/highlight#",schema:"http://schema.org/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",gist:"http://ontologies.semanticarts.com/gist#",rdfs:"http://www.w3.org/2000/01/rdf-schema#"};var sa={reserved_words:{baseURL:function(){return window.location.origin},currentURL:function(){return window.location.href},accountId:schemaAppgetAccountId}};var applicableTemplates=[];var config=null;var resourcesReady=false;var templatesLoaded=false;var schemaServer="https://cdn.schemaapp.com";var schemaCDN="https://data.schemaapp.com/";var ytServer="https://api.hunchmanifest.com";var LOCAL_STORAGE_KEY=location.host+"-schemaapp";var templateDict={};var TEXT_NODE=3;var CAPTURE_PAGE=false;var API_KEY_FIELD="X-API-KEY";var ANALYTICS_ENDPOINT="https://0yl6pcjbij.execute-api.us-east-1.amazonaws.com/prod";var ANALYTICS_KEY="BiQcqdttWn7eunp8jvxM5oZl3DIx08J42LtTmaaj";var externalResources=[];var unmatchedXPaths=0;var totalXPaths=0;var timeOutSet=false;var deployedTemplates={};function XPathFailed(a){this.name="XPath Failure";this.message="The following xpath was not found: "+a}function countXPath(a){if(a===null){unmatchedXPaths+=1}totalXPaths+=1}function applyContentFilter(a,c){if(typeof a!=="string"){return a}var e=a.trim();var b=[];if(c){var d=c.split('");');d.splice(d.length-1,1);d.forEach(function(g){var f={optionSelected:null,filterText:""};var h=g.split('("');f.optionSelected=h[0];if(h[1]){f.filterText=h[1]}b.push(f)})}b.forEach(function(g){if(e==null){return a}var n=e.toLowerCase();var l=g.filterText.toLowerCase();switch(g.optionSelected){case"BEFORE":if(g.filterText){var m=n.indexOf(l);if(m>=0){e=e.slice(0,m)}else{e=""}}break;case"AFTER":if(g.filterText){var m=n.indexOf(l);if(m>=0){e=e.slice(m+l.length)}else{e=""}}break;case"OMIT":e=e.split(g.filterText).join("");break;case"NUMBER":var j=a;var h=document.createElement("div");h.innerHTML=j;a=h.innerText;var i=/(\+|-)*((\d+[.]\d*)|(\d*[.]\d+)|\d+)/mi;var f=new RegExp(i);var k=f.exec(e);k?e=k[0]:e=null;break;case"NONNUMBER":e=e.replace(/\d+/gm,"");break}});return e?e:a}function insertInto(f,g,c){if(g==null||g.length===0){return}if(!f.includes("~")){if(c[f]!==undefined&&c[f].constructor===Array){if(g.constructor===Array){c[f]=c[f].concat(g)}else{c[f].push(g)}}else{if(g.constructor!==Array){c[f]=[g]}else{c[f]=g}}return}var h=f.split("~");var a=c;for(var e=1;e<=h.length;e++){var k=h[e-1];if(e%2===0){if(a.length==0){a.push({"@type":k});a=a[0];continue}if(a[0]["@type"]===undefined){a[0]["@type"]=k;a=a[0];continue}var b=false;for(var d=0;d<a.length;d++){if(a[d]["@type"]==k){a=a[d];b=true;break}}if(b==false){a.push({"@type":k});a=a[a.length-1]}}else{if(e===h.length){if(a[k]!==undefined&&a[k].constructor==Array){a[k]=a[k].concat(g)}else{a[k]=g}}else{if(a[k]===undefined){a[k]=[]}}a=a[k]}}}function hasLocalStorage(a){try{var c=window[a];item="Test";c.setItem(item,item);c.removeItem(item);return true}catch(b){console.log("Storage not available "+b.code+" "+b.name)}return false}function injectJSON(b){if(b!==""){var a=document.createElement("script");a.type="application/ld+json";a.innerHTML=b;document.getElementsByTagName("head")[0].appendChild(a)}}function persistToLocalStorage(a){if(hasLocalStorage("sessionStorage")){var b=window.sessionStorage;b.setItem(LOCAL_STORAGE_KEY,JSON.stringify(a))}}var schemaAppgetAccountId=function(){var b=getEntityByType(config,"Organization",ns.gist).pop();var a=getObjects(config,b,ns.gist+"describedIn").pop();if(a==null){return null}return a.replace("http://schemaapp.com/db/","")};function btoaUTF16(b){var a=new Uint16Array(b.length);Array.prototype.forEach.call(a,function(e,d,c){c[d]=b.charCodeAt(d)});return btoa(String.fromCharCode.apply(null,new Uint8Array(a.buffer)))}function countPageForAnalytics(c){var a=window.location.origin+window.location.pathname;var h=schemaAppgetAccountId();if(h===null){return}var j=h.split("/");for(var d=0;d<applicableTemplates.length;d++){var b=applicableTemplates[d].replace("http://schemaapp.com/db/","");b=b.replace("http://schemaapp.com/resources/admin/Company_","");if(c.length===1){c=c[0]}var f={AccountId:j[0],SubAccount:j[1]!==undefined?j[1]:"",DateSeen:"2019-08-14",Source:"HighlightJS:"+applicableTemplates[d],Domain:window.location.origin,URL:a,Json:JSON.stringify(c)};var k=new XMLHttpRequest();k.open("POST",ANALYTICS_ENDPOINT,true);k.setRequestHeader(API_KEY_FIELD,ANALYTICS_KEY);k.setRequestHeader("content-type","text/plain");try{k.send(btoaUTF16(JSON.stringify(f)))}catch(g){}}}function schemaAppLoadResources(){var c=window.location.protocol+"//"+window.location.host;var b=btoa(unescape(c)).replace(/=/g,"");var a=schemaServer+"/highlighter/prod/"+b;var d=new XMLHttpRequest();d.onreadystatechange=function(){if(this.readyState!==4||this.status!==200){return}config=JSON.parse(d.responseText);processConfig();persistToLocalStorage(config)};d.open("GET",a,true);d.send()}function processConfig(){var b=getEntityByType(config,"HighlightTemplate");var a=[location.protocol,"//",location.host,location.pathname].join("");b.forEach(function(v){var n=true;var m=config[v];if(m[ns.high+"pattern"]===undefined){return}for(var s=0;s<m[ns.high+"pattern"].length;s++){var c=m[ns.high+"pattern"][s];var t=config[c.value];var q=t[ns.gist+"categorizedBy"];var u=t[ns.gist+"hasMember"];for(var r=0;r<u.length;r++){var g=q[0];var p=g.value.replace(ns.high,"");var h=t[ns.gist+"hasMember"][r];var l=h.value;if(p==="GlobCollection"){if(globChecker(a,l)){n=false}}else{if(p==="XPathCollection"){var w=document.evaluate(l,document);if(w.resultType===3&&w.booleanValue){n=false;continue}if(w.resultType==4){var e=document.evaluate(l,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);if(e.snapshotLength>0){n=false}}}else{if(l.toLowerCase()==a.toLowerCase()){n=false}}}}}if(!n){var f="";if(m[ns.rdfs+"label"]!==undefined){var k=m[ns.rdfs+"label"].pop();if(k!==undefined){f=k.value}}var o=false;for(var s=0;s<applicableTemplates.length;s++){var d=applicableTemplates[s];if(d==v){o=true}}if(o===false){console.log("Pushing Template ("+f+") with uri: "+v);applicableTemplates.push(v)}}});resourcesReady=true;if(applicableTemplates.length>0){loadTemplates()}}function processHighlights(c,a,d){var b=0;c.forEach(function(g){var f=getObjects(config,g,ns.rdf+"type");var l=config[g];if(l==undefined){return}if(d!==undefined){l[ns.high+"xPath"][0]["value"]=d+l[ns.high+"xPath"][0]["value"]}var e=tagFactory(f[0],l);var i=e[0];var k=i[ns.high+"propertyPath"][0].value;var j=Tag.extract(e,document,a);countXPath(j);insertInto(k,j,a);if(j){b+=1}});return b}function processListTagHighlights(k,e,o,c){if(o==undefined||o[ns.high+"xPath"]==undefined){return}var d=o[ns.high+"xPath"][0]["value"];var j=[];var f=o[ns.high+"propertyPath"][0]["value"].split("~");var m=o[ns.high+"propertyPath"][0]["value"];var l=undefined;var n=m;if(f.length>1){l=f.pop();n=f.join("~")}var a=document.evaluate(d,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);if(a.length==0){throw new XPathFailed(d)}for(var h=0;h<a.snapshotLength;h++){var g=a.snapshotItem(h);if(l){var b={"@type":l,"@id":window.location.href+"#"+l.replace("http://schema.org/","")+"_"+c};if(l==="ListItem"){b.position=h}}k.forEach(function(y){var t=getObjects(config,y,ns.rdf+"type");var w=config[y];var z=null;var B=tagFactory(t[0],w);var A=B[0];if(w[ns.rdf+"type"][0]["value"]===ns.high+"TagXPath"){if(!w[ns.high+"xPath"]){z="text()";w[ns.high+"xPath"]=[{value:z}]}else{z=w[ns.high+"xPath"][0]["value"]}if(z.indexOf("|")===-1&&z.indexOf("(")===0){z=z.replace(/^\(+|(\)\s*)+$/gm,"").trim()}else{if(z!="text()"){var s=z.replace(/^\(|\)$/gm,"").trim().split("|");var r=[];for(var v=0;v<s.length;v++){var q=s[v].trim();if(q.indexOf("//")===0){q=q.slice(2)}if(q.indexOf("/")===0){q=q.slice(1)}r.push(q)}z="( "+r.join(" | ")+" )"}}if(z.indexOf("//")===0){w[ns.high+"xPath"][0]["value"]=z.slice(2)}else{if(z.indexOf("contains")===-1){w[ns.high+"xPath"][0]["value"]=z.indexOf("/")==0?z.slice(1):z}else{w[ns.high+"xPath"][0]["value"]=z}}if(z===""){w[ns.high+"xPath"][0]["value"]="."}}var B=tagFactory(t[0],w);var A=B[0];var x="";if(A[ns.high+"propertyPath"]===undefined){x=m}else{x=A[ns.high+"propertyPath"][0].value}if(A[ns.high+"useDocumentContext"]&&A[ns.high+"useDocumentContext"][0].value==="true"){var u=Tag.extract(B)}else{var u=Tag.extract(B,g)}countXPath(u);if(l){insertInto(x,u,b)}else{b=u}});c++;j.push(b)}insertInto(n,j,e);return{resource:e,objectCount:a.snapshotLength}}function loadTemplates(){if(!resourcesReady){return false}var i=[];for(var s=0;s<applicableTemplates.length;s++){var q=applicableTemplates[s];if((deployedTemplates.hasOwnProperty(q)&&deployedTemplates[q].ok)||(deployedTemplates.hasOwnProperty(q)&&deployedTemplates[q].attempted>=2)){continue}try{var d=getObjects(config,q,ns.gist+"categorizedBy");var k={"@context":"http://schema.org/","@type":d,"@id":window.location.href+"#"+d[0].replace("http://schema.org/",""),url:window.location.href};var p=[];var o=[];var m=getObjects(config,q,ns.high+"hasHighlight");for(var g=0;g<m.length;g++){var l=m[g];var j=getObjects(config,l,ns.rdf+"type");if(j==ns.high+"TagList"){o.push(l)}else{p.push(l)}}var a=processHighlights(p,k);var b=0;for(var r=0;r<o.length;r++){var l=o[r];var f=config[l];var c=getObjects(config,l,ns.high+"hasTemplate");var m=getObjects(config,c,ns.high+"hasHighlight");res=processListTagHighlights(m,k,f,b);if(res){k=res.resource;b+=res.objectCount}}injectJSON(JSON.stringify(k));i.push(JSON.parse(JSON.stringify(k)));if(deployedTemplates.hasOwnProperty(q)){deployedTemplates[q].ok=true;deployedTemplates[q].attempted=deployedTemplates[q].attempted+=1}else{deployedTemplates[q]={ok:true,attempted:1}}}catch(n){if(n instanceof XPathFailed){window.setTimeout(function(){if(deployedTemplates.hasOwnProperty(q)){deployedTemplates[q].ok=false;deployedTemplates[q].attempted=deployedTemplates[q].attempted+=1}else{deployedTemplates[q]={ok:false,attempted:1}}loadTemplates()},500)}}}countPageForAnalytics(i)}function getObjects(b,c,a){var e=[];for(var d in b[c]){if(d===a){for(var f in b[c][d]){if(b[c][d][f].type==="uri"){e.push(b[c][d][f].value)}else{if(b[c][d][f].type==="literal"){e.push(b[c][d][f].value)}}}}}return e}function getEntityByType(a,c,e){if(e===undefined){e=ns.high}var f=[];for(var b in a){for(var d in a[b]){if(d===ns.rdf+"type"){if(a[b][d][0].value===(e+c)){f.push(b)}}}}return f}function tagFactory(b,a){if(b===(ns.high+"TagXPath")||b===(ns.high+"TagXPathDefined")){return Tag.construct(a,Tag.tagTypes.TagXPath)}else{if(b===(ns.high+"TagDefined")){return Tag.construct(a,Tag.tagTypes.TagDefined)}else{if(b===(ns.high+"TagStoredResource")){return Tag.construct(a,Tag.tagTypes.TagStoredResource)}else{if(b===(ns.high+"TagYouTube")){return Tag.construct(a,Tag.tagTypes.TagYouTube)}else{if(b===(ns.high+"TagLookup")){return Tag.construct(a,Tag.tagTypes.TagLookup)}}}}}throw new TypeError("Tag Factory unable to create class "+b)}var Utility={convertToNumeric:function(c){var a=c.trim();var b=Number(a);return(b===NaN||b.toString()==="NaN")?c:b},encodeHtmlEntities:function(b){var a=document.createElement("textarea");a.textContent=b;return a.innerHTML}};var Tag={tagTypes:Object.freeze({TagXPath:1,TagDefined:2,TagStoredResource:3,TagYouTube:4,TagLookup:5}),construct:function(a,b){return[a,[],b]},extract:function(b,a,d){var c=b[2];if(a===undefined){a=document}switch(c){case Tag.tagTypes.TagXPath:return Tag.xpathExtract(b,a);case Tag.tagTypes.TagDefined:return Tag.tagDefined(b);case Tag.tagTypes.TagStoredResource:return Tag.storedResource(b);case Tag.tagTypes.TagYouTube:return Tag.videoResource(b,a);case Tag.tagTypes.TagLookup:return Tag.tagLookup(b,a,d)}},getContentFromElement:function(e){if(e==undefined){return null}if(e.localName==undefined){return e.value}var c=e.localName.toLowerCase();if(c==="href"||c=="@href"){var b=document.createElement("a");b.href=e.textContent;return b.href}if(e.nodeType===TEXT_NODE){return e.wholeText}if(e.constructor===Attr){return e.value}var d=new Set(["img","video","audio","source","embed"]);var h=new Set(["meta"]);if(d.has(c)){if(e.hasAttribute("src")){var a=e.getAttribute("src");if(!a.startsWith("http")&&!a.startsWith("//")){a=window.location.protocol+"//"+window.location.host+a}else{if(a.startsWith("//")){a=window.location.protocol+a}}return a}else{return Tag.getContentFromElement(e.getElementsByTagName("source")[0])}}else{if(h.has(c)){var i=e.getAttribute("content");return i}}var f=e.cloneNode(true);removeScripts(f);var g=f.innerHTML;return g},tagDefined:function(b){var a=b[0];return a[ns.high+"value"][0].value},videoResource:function(c,b){var d=c[0];var g=d[ns.high+"xPath"][0].value;var f=document.evaluate(g,b,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotItem(0);if(!f){return null}var e=new URL(f.src);var a=e.pathname.replace("/","").replace("embed/","");var i=[{"@id":e.origin+e.pathname}];var h=new XMLHttpRequest();h.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var j=JSON.parse(h.responseText);j["@id"]=e.origin+e.pathname;injectJSON(JSON.stringify(j))}};h.open("GET",ytServer+"/schemaorg/video.json?ids="+a,true);h.send();return i},xpathExtract:function(e,d){var f=e[0];var l,i;var c="";if(f[ns.high+"xPath"]==undefined||f[ns.high+"xPath"][0]==undefined){return null}i=f[ns.high+"xPath"][0].value;if(i===""){return null}if(f[ns.high+"filter"]!==undefined){c=f[ns.high+"filter"][0].value}if(i.includes("preceeding-sibling")||i.includes("following-sibling")){try{var b=document.evaluate(i,d,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE)}catch(j){return""}var l="";for(var k=0;k<b.snapshotLength;k++){var h=b.snapshotItem(k);l+=Tag.getContentFromElement(h)+"\n"}l=applyContentFilter(l,c)}else{try{var h=document.evaluate(i,d,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE).snapshotItem(0)}catch(j){console.log(i);console.log(f);console.log(c);console.log(j);return""}if(!h){return null}l=Tag.getContentFromElement(h);l=applyContentFilter(l,c)}if(l!=null){var g=document.createElement("div");g.innerHTML=l;l=g.innerText;l=l.replace(/\s\s+/g," ");l=Utility.encodeHtmlEntities(l);var a=Utility.convertToNumeric(l);return a}return null},storedResource:function(a){var b=a[0];var c=false;if(!b[ns.high+"value"]){return}var j=b[ns.high+"value"][0].value;var d=btoa(unescape(j)).replace(/=/g,"");var g=schemaAppgetAccountId();if(g===null){return}var f=schemaCDN+g+"/"+d;for(var e=0;e<externalResources.length;e++){var h=externalResources[e];if(h==j){return[{"@id":j}]}}externalResources.push(j);Tag.makeExternalRequest(f);return[{"@id":j}]},tagLookup:function(c,b,e){var d=c[0];var n,j;var a="";if(d[ns.high+"xPath-input"]){j=d[ns.high+"xPath-input"][0].value;var q=document.evaluate(j,b,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);if(q.snapshotLength>0){n=Tag.getContentFromElement(q.snapshotItem(0))}}if(d[ns.high+"filter"]!==undefined){a=d[ns.high+"filter"][0].value}if(a!=""&&n!=""){n=applyContentFilter(n,a)}var k=d[ns.schema+"target"][0]["value"];var l=k.match(/{([a-zA-Z-]+)}/gm);var p={};for(var f=0;f<l.length;f++){var m=l[f].replace(/{|}/gm,"");if(sa.reserved_words[m]){p[m]=sa.reserved_words[m]}if(m=="xPath-input"){p[m]=n}}for(var o in p){if(typeof p[o]=="function"){k=k.replace(o,p[o]())}else{k=k.replace(o,p[o])}}k=k.replace(/{|}/gm,"");var h={"@context":"http://schema.org/","@type":e["@type"],"@id":e["@id"]};var g=d[ns.high+"propertyPath"][0]["value"];Tag.makeExternalRequest(encodeURI(k),h,g)},makeExternalRequest:function(b,a,c){var d=new XMLHttpRequest();d.onreadystatechange=function(){if(this.readyState===4&&this.status===200){if(d.responseText===""){return}if(a){insertInto(c,JSON.parse(d.responseText),a);injectJSON(JSON.stringify(a))}else{injectJSON(d.responseText)}}};d.open("GET",b,true);d.send()}};function removeScripts(b){var c=[];if(b.children){for(var a=0;a<b.children.length;a++){var d=b.children[a];removeScripts(d);if(d.localName.toLowerCase()==="script"){c.push(d)}}}for(var a=0;a<c.length;a++){b.removeChild(c[a])}}function globChecker(h,g){if(g.charAt(0)!=="/"){g="/"+g}h=h.replace(new RegExp(".+://"),"");var b=h.split("/");var c=g.split("/");for(var d=1;d<b.length;d++){var a=b[d].toLowerCase();if(c.length>d){var f=c[d].toLowerCase();if(f.length===0){continue}if(f==="*"){continue}else{if(f==="**"){return true}else{var e=f;completeMatch=false;if(f.includes("**")){e=f.replace("**","*");completeMatch=true}e=e.replace("*",".*");e="^"+e+"$";if(a.match(new RegExp(e))){if(completeMatch){return true}continue}}}if(a!==f){return false}}else{return false}}return(d>=c.length)}if(hasLocalStorage("sessionStorage")){var storedTemplates=window.sessionStorage.getItem(LOCAL_STORAGE_KEY);if(storedTemplates!==null){config=JSON.parse(storedTemplates);resourcesReady=true;processConfig()}else{schemaAppLoadResources()}}else{schemaAppLoadResources()}window.setTimeout(function(){timeOutSet=true;processConfig()},350);